University: [ITMO University](https://itmo.ru/ru/) \
Faculty: [FICT](https://fict.itmo.ru) \
Course: [Network programming](https://github.com/itmo-ict-faculty/network-programming) \
Year: 2023/2024 \
Group: K34202 \
Author: Shabashov Vasiliy Andreevich \
Lab: Lab4 \
Date of create: 07.12.2023

# Лабораторная работа №4 "Базовая 'коммутация' и туннелирование используя язык программирования P4"

## Цель работы
Изучить синтаксис языка программирования P4 и выполнить 2 обучающих задания от Open network foundation для ознакомления на практике с P4.

## Ход работы
Клонировали репозиторий p4lang/tutorials и установили Vagrant. Перешли в папку vm-ubuntu-20.04 и развернули тестовую среду с помощью Vagrant. В результате установки на VirtualBox появилась виртуальная машина с аккаунтами vagrant/vagrant и p4/p4.

### Задание 1

Под учётной записью p4 скомпилирован файл basic.p4 командой make run. Проверили, что пинг не проходит из-за сброса всех пакетов по умолчанию:

![ping](1.png)

В скомпилированный файл добавили парсеры для ipv4 и ethernet загловков:

![parser](2.png)

Прописано действие отправки пакета IPv4 с указанием порта, на который должны отправляться пакеты. Затем обновляется адрес назначения Ethernet и обновляется исходный адрес Ethernet, и время жизни пакета уменьшается на 1:

![img](3.png)

Определена таблица маршрутицазии:

![img](4.png)

Написали условие применения ipv4_lpm, если заголовок ipv4 валидный:

![img](5.png)

С помощью команды pingall снова проверили подключение, пинг проходит:

![img](6.png)

### Задание 2

Теперь меняем файл basic_tunnel.p4 для настройки туннелирования.

Обновили парсер myParser, определив новый заголовок myTunnel:

![img](7.png)

![img](8.png)

Добавлен парсер parse_myTunnel, который извлекает заголовок myTunnel:

![img](9.png)

Внесены изменения в парсер parse_ethernet, чтобы осуществлять извлечение ipv4 заголовка или myTunnel заголовка, в зависимости от значения поля etherType:

![img](10.png)

Далее определили таблицу myTunnel_exact, которая управляет маршрутизацией пакетов myTunnel. Эта таблица вызывает функцию myTunnel_forward, которая определяет порт для отправки исходящих пакетов:

![img](11.png)

![img](12.png)

Изменили функцию apply, которая выбирает соответствующую таблицу в зависимости от типа пакетов:

![img](13.png)

Написали депарсер:

![img](14.png)

Дальше отправили пакет с h1 на h2 без использования туннелирования, и переданное сообщение было успешно доставлено до адресата:

![img](15.png)

После этого отправили пакет на адрес h3, используя данные для заголовка туннелирования dst_id для h2. Вместо того, чтобы достичь h3, пакет был перенаправлен на h2 из-за применения таблицы маршрутизации myTunnel_exact:

![img](16.png)

### Схемы

![img](17.png)

![img](18.png)

## Вывод
В процессе выполнения лабораторной работы были исследованы возможности стандартного перенаправления пакетов и туннелирования. Также были реализованы эти механизмы с использованием языка P4.
